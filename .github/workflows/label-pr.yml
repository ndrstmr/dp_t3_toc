name: "Auto Label PR"

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Label PR based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml

      - name: Label PR based on title (Conventional Commits)
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const labels = [];

            // Extract conventional commit type
            const match = title.match(/^(\w+)(\([\w-]+\))?!?:/);
            if (match) {
              const type = match[1];

              // Map commit types to labels
              const typeMap = {
                'feat': 'enhancement',
                'fix': 'bug',
                'docs': 'documentation',
                'style': 'code-style',
                'refactor': 'refactoring',
                'test': 'tests',
                'chore': 'chore',
                'ci': 'ci',
                'perf': 'performance'
              };

              if (typeMap[type]) {
                labels.push(typeMap[type]);
              }

              // Check for breaking change
              if (title.includes('!:') || title.includes('BREAKING CHANGE')) {
                labels.push('breaking-change');
              }

              // Extract scope if present
              const scope = match[2]?.replace(/[()]/g, '');
              if (scope) {
                const scopeMap = {
                  'toc': 'scope:toc',
                  'processor': 'scope:processor',
                  'repository': 'scope:repository',
                  'service': 'scope:service',
                  'tests': 'scope:tests',
                  'ci': 'scope:ci',
                  'docs': 'scope:docs'
                };

                if (scopeMap[scope]) {
                  labels.push(scopeMap[scope]);
                }
              }
            }

            // Add labels if any were found
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }

      - name: Label PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;

            let sizeLabel = '';

            if (totalChanges < 10) {
              sizeLabel = 'size:xs';
            } else if (totalChanges < 50) {
              sizeLabel = 'size:s';
            } else if (totalChanges < 200) {
              sizeLabel = 'size:m';
            } else if (totalChanges < 500) {
              sizeLabel = 'size:l';
            } else {
              sizeLabel = 'size:xl';
            }

            // Remove old size labels
            const existingLabels = pr.labels.map(l => l.name);
            const sizeLabels = existingLabels.filter(l => l.startsWith('size:'));

            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: label
              });
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });

      - name: Add "needs-review" label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);

            // Only add if not already present and PR is ready for review
            if (!labels.includes('needs-review') && !context.payload.pull_request.draft) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: ['needs-review']
              });
            }
